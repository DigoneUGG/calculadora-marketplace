<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora Universal de Marketplace</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(125deg, #ff2020, #3300ff);
      transition: background 0.8s ease;
    }

    .container {
      width: 90%;
      max-width: 400px;
      text-align: center;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }

    .hidden {
      display: none;
    }

    .fade-in {
      animation: fadeIn 0.8s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    h1,
    h2 {
      font-weight: 700;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #fff;
      margin-bottom: 20px;
    }

    h2 {
      color: #fff;
      margin-bottom: 15px;
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.85);
      font-size: 16px;
      color: #000;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: #007bff;
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      transition: background 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .link-btn {
      background: none;
      color: #fff;
      text-decoration: underline;
      margin-top: 10px;
      cursor: pointer;
      display: block;
    }

    .logo-container {
      width: 100px;
      height: 100px;
      margin: 10px auto;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: transparent;
      transition: background 0.5s ease;
    }

    .logo-container img {
      border-radius: 50%;
      width: 80%;
      height: auto;
      object-fit: contain;
    }

    div#app {
      margin: 10px !important;
      padding: 5px !important;
    }

    .result-box {
      background: rgba(255, 255, 255, 0.3);
      padding: 15px;
      border-radius: 12px;
      margin-top: 15px;
      font-weight: bold;
      color: #fff;
    }

    #logoutBtn {
      background: #007bff;
      width: 70px;
      height: 35px;
      border-radius: 8px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 20px;
      right: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      color: white;
    }

    #logoutBtn:hover {
      background: #0056b3;
    }

    #historico {
      display: none;
      width: 90%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border-radius: 15px;
      padding: 20px;
      text-align: left;
    }

    #historico h3 {
      text-align: center;
    }

    #searchBox {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: none;
    }

    #listaHistorico {
      max-height: 200px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 10px;
    }

    #searchIcon {
      position: absolute;
      right: 40px;
      top: 12px;
      font-size: 20px;
      color: #444;
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div class="container" id="login-container">
    <div class="logo-container" style="margin-bottom: 15px;">
      <img src="logo-cal-mkt.png" alt="Logo Calculadora Universal">
    </div>
    <h1>Calculadora Universal<br>de Marketplace</h1>

    <div id="login" class="fade-in">
      <input type="text" id="loginUser" placeholder="Usuário">
      <input type="password" id="loginPass" placeholder="Senha">
      <button onclick="login()">Entrar</button>
      <div class="link-btn" onclick="showRegister()">Criar conta</div>
      <div class="link-btn" onclick="showForgot()">Esqueci minha senha</div>
    </div>

    <div id="register" class="hidden fade-in">
      <input type="text" id="regName" placeholder="Nome completo">
      <input type="email" id="regEmail" placeholder="E-mail">
      <input type="text" id="regUser" placeholder="Usuário">
      <input type="password" id="regPass" placeholder="Senha">
      <button onclick="register()">Cadastrar</button>
      <div class="link-btn" onclick="showLogin()">Já tenho conta</div>
    </div>

    <div id="forgot" class="hidden fade-in">
      <input type="text" id="forgotUser" placeholder="Digite seu nome de usuário">
      <button onclick="recoverPassword()">Recuperar senha</button>
      <div class="link-btn" onclick="showLogin()">Voltar ao login</div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="fade-in hidden">
    <div class="logo-container" id="logoContainer">
      <img src="logo-cal-mkt.png" alt="Logo padrão">
    </div>

    <h2>Calculadora Universal de Marketplace</h2>

    <select id="plataforma" onchange="atualizarPlataforma()">
      <option value="">Selecione uma plataforma</option>
    </select>

    <input type="text" id="produto" placeholder="Nome do produto">
    <input type="text" id="valorProduto" placeholder="Valor do produto (R$0,00)" oninput="formatarValor(this)">
    <input type="number" id="quantidadeProduto" placeholder="Quantidade">
    <input type="text" id="valorFrete" placeholder="Valor do frete (opcional R$0,00)" oninput="formatarValor(this)">

    <div class="result-box" id="resultado"></div>

    <button id="verHistorico" onclick="abrirHistorico()">📜 Ver histórico</button>
    <button id="logoutBtn" onclick="logout()">Logout</button>
  </div>

  <!-- HISTÓRICO -->
  <div id="historico" class="fade-in">
    <h3>Histórico de Cálculos</h3>
    <div style="position: relative;">
      <input type="text" id="searchBox" placeholder="Pesquisar produto..." oninput="filtrarHistorico()">
      <span id="searchIcon">🔍</span>
    </div>
    <div id="listaHistorico"></div>
    <button onclick="voltarApp()">Voltar</button>
  </div>

  <script>
    let plataformas = {};
    let historico = JSON.parse(localStorage.getItem("historico")) || [];

    async function carregarTarifas() {
      try {
        const resposta = await fetch("https://cdn.jsdelivr.net/gh/DigoneUGG/calculadora-marketplace@main/tarifas.json");
        if (!resposta.ok) throw new Error("Erro ao carregar tarifas");
        plataformas = await resposta.json();
        preencherSelect();
      } catch {
        alert("Não foi possível carregar as tarifas.");
      }
    }

    function preencherSelect() {
      const select = document.getElementById("plataforma");
      select.innerHTML = '<option value="">Selecione uma plataforma</option>';
      for (const nome in plataformas) {
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome.charAt(0).toUpperCase() + nome.slice(1);
        select.appendChild(opt);
      }
    }

    function atualizarPlataforma() {
      const select = document.getElementById("plataforma");
      const plataforma = plataformas[select.value];
      const logoContainer = document.getElementById("logoContainer");
      const body = document.body;

      if (plataforma) {
        body.style.background = `linear-gradient(135deg, ${plataforma.cor}, ${darken(plataforma.cor, 40)})`;
        logoContainer.style.background = "#fff";
        logoContainer.innerHTML = `<img src="${plataforma.logo}" alt="${select.value}">`;
      } else {
        body.style.background = "linear-gradient(135deg, #e0e0e0, #555)";
        logoContainer.style.background = "transparent";
        logoContainer.innerHTML = `<img src="logo-cal-mkt.png" alt="Logo padrão">`;
      }
      calcular();
    }

    function formatarValor(input) {
      let v = input.value.replace(/\D/g, "");
      v = (v / 100).toFixed(2) + "";
      v = v.replace(".", ",");
      v = "R$ " + v.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      input.value = v;
      calcular();
    }

    function calcular() {
      const select = document.getElementById("plataforma");
      const plataforma = plataformas[select.value];
      if (!plataforma) return;

      const nomeProduto = document.getElementById("produto").value || "Sem nome";
      const valorProduto = parseFloat(document.getElementById("valorProduto").value.replace(/[R$\s.]/g, "").replace(",", ".")) || 0;
      const quantidade = parseFloat(document.getElementById("quantidadeProduto").value) || 1;
      const valorFrete = parseFloat(document.getElementById("valorFrete").value.replace(/[R$\s.]/g, "").replace(",", ".")) || 0;

      const tarifa = plataforma.tarifa || 0;
      const valorMenos = valorProduto - (valorProduto * tarifa / 100);
      const valorMais = valorProduto + (valorProduto * tarifa / 100);
      const valorFinal = (valorMais + valorFrete) * quantidade;

      const resultado = document.getElementById("resultado");
      resultado.innerHTML = `
        <div>Tarifa: ${tarifa}%</div>
        <div>Valor para menos: R$ ${valorMenos.toFixed(2)}</div>
        <div>Valor para mais: R$ ${valorMais.toFixed(2)}</div>
        <div>Valor final com frete: R$ ${valorFinal.toFixed(2)}</div>
      `;

      historico.push({ produto: nomeProduto, plataforma: select.value, total: valorFinal.toFixed(2), data: new Date().toLocaleString() });
      localStorage.setItem("historico", JSON.stringify(historico));
    }

    function abrirHistorico() {
      document.getElementById("app").style.display = "none";
      document.getElementById("historico").style.display = "block";
      exibirHistorico();
    }

    function exibirHistorico() {
      const lista = document.getElementById("listaHistorico");
      lista.innerHTML = historico.map(item => `<div>🛒 ${item.produto} | ${item.plataforma} | R$ ${item.total} <br><small>${item.data}</small></div><hr>`).join("");
    }

    function filtrarHistorico() {
      const termo = document.getElementById("searchBox").value.toLowerCase();
      const lista = document.getElementById("listaHistorico");
      const filtrado = historico.filter(item => item.produto.toLowerCase().includes(termo));
      lista.innerHTML = filtrado.map(item => `<div>🛒 ${item.produto} | ${item.plataforma} | R$ ${item.total}</div><hr>`).join("");
    }

    function voltarApp() {
      document.getElementById("historico").style.display = "none";
      document.getElementById("app").style.display = "block";
    }

    function darken(color, percent) {
      let num = parseInt(color.replace("#", ""), 16),
        amt = Math.round(2.55 * percent),
        R = (num >> 16) - amt,
        G = (num >> 8 & 0x00FF) - amt,
        B = (num & 0x0000FF) - amt;
      return "#" + (
        0x1000000 +
        (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
        (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
        (B < 255 ? (B < 1 ? 0 : B) : 255)
      )
        .toString(16)
        .slice(1);
    }

    /* LOGIN */
    function login() {
      const user = document.getElementById("loginUser").value;
      const pass = document.getElementById("loginPass").value;
      if (user === localStorage.getItem("user") && pass === localStorage.getItem("pass")) {
        localStorage.setItem("loggedIn", "true");
        transitionToApp();
      } else alert("Usuário ou senha incorretos.");
    }

    function register() {
      const name = document.getElementById("regName").value;
      const email = document.getElementById("regEmail").value;
      const user = document.getElementById("regUser").value;
      const pass = document.getElementById("regPass").value;
      if (name && email && user && pass) {
        localStorage.setItem("user", user);
        localStorage.setItem("pass", pass);
        localStorage.setItem("email", email);
        alert("Cadastro realizado com sucesso!");
        showLogin();
      } else alert("Preencha todos os campos.");
    }

    function showRegister() {
      document.getElementById("login").classList.add("hidden");
      document.getElementById("register").classList.remove("hidden");
      document.getElementById("forgot").classList.add("hidden");
    }

    function showLogin() {
      document.getElementById("register").classList.add("hidden");
      document.getElementById("login").classList.remove("hidden");
      document.getElementById("forgot").classList.add("hidden");
    }

    function showForgot() {
      document.getElementById("login").classList.add("hidden");
      document.getElementById("register").classList.add("hidden");
      document.getElementById("forgot").classList.remove("hidden");
    }

    function recoverPassword() {
      const user = document.getElementById("forgotUser").value;
      const storedUser = localStorage.getItem("user");
      const storedPass = localStorage.getItem("pass");
      if (user === storedUser) {
        alert(`Sua senha é: ${storedPass}`);
        showLogin();
      } else {
        alert("Usuário não encontrado.");
      }
    }

    function logout() {
      localStorage.setItem("loggedIn", "false");
      location.reload();
    }

    function transitionToApp() {
      document.getElementById("login-container").style.display = "none";
      const app = document.getElementById("app");
      app.style.display = "block";
      app.classList.add("fade-in");
    }

    window.onload = function () {
      carregarTarifas();
      if (localStorage.getItem("loggedIn") === "true") transitionToApp();
    };
  </script>
</body>

</html>